 <!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Advanced Stock Screener & Backtest</title>
  <style>
    body{font-family:sans-serif;background:#f0f2f5;margin:0;color:#333}
    .container{max-width:900px;margin:30px auto;background:#fff;padding:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h1,h2{margin-top:0}
    select,input,button{padding:6px 10px;font-size:1rem;margin:0 5px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border:1px solid #ddd;padding:6px;text-align:left}
    th{background:#f7f7f7}
    .loading{opacity:.6}
    .section{margin-top:30px}
    label{margin-right:10px}
    #progress{margin-top:10px;font-weight:bold}
  </style>
</head>
<body>
<div class="container">
  <h1>Advanced Stock Screener & Backtest</h1>
  <div>
    <label>Indice
      <select id="idx">
        <option value="US">USA (S&P 500 demo)</option>
        <option value="IT">Italia (FTSE MIB demo)</option>
      </select>
    </label>
    <button id="scan">Scansiona</button>
    <span id="progress"></span>      <!-- PROGRESS INDICATOR -->
  </div>

  <div class="section">
    <h2>Risultati Screener</h2>
    <table>
      <thead>
        <tr><th>#</th><th>Ticker</th><th>Score</th><th>Motivazioni</th></tr>
      </thead>
      <tbody id="screener-out"></tbody>
    </table>
  </div>

  <!-- backtest omesso per brevità… -->
</div>

<script>
//–– DEMO CONSTITUENTI
const constituents = {
  "US":[ "AAPL","MSFT","AMZN","GOOGL","META","TSLA","NVDA","JPM","V","PG",
         "UNH","MA","HD","INTC","DIS","NFLX","KO","PFE","XOM","CVX" ],
  "IT":[ "ENEL.MI","ISP.MI","ENI.MI","UCG.MI","STM.MI","EXO.MI","STLA.MI","ATL.MI",
         "PRT.MI","RACE.MI","LDO.MI","TIT.MI","G.MI","MONC.MI","A2A.MI","TEN.MI" ]
};

//–– HELPERS
const CORS = url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
function parsePct(s){return s?parseFloat(s.replace('%',''))/100:0}

// fetch fondamentali + bilancio
async function fetchFund(ticker){
  try{
    const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${ticker}`+
                `?modules=defaultKeyStatistics,financialData,incomeStatementHistoryQuarterly`;
    const r=await fetch(CORS(url)), j=await r.json(), R=j.quoteSummary.result[0];
    const pe = R.defaultKeyStatistics.trailingPE?.raw || null;
    const pb = R.defaultKeyStatistics.priceToBook?.raw || null;
    const roa= parsePct(R.financialData.returnOnAssets?.fmt);
    const de = parseFloat(R.financialData.debtToEquity?.fmt)||0;
    const inc=R.incomeStatementHistoryQuarterly.incomeStatementHistory[0];
    const pm = inc.netIncome?.raw/inc.totalRevenue?.raw||0;
    const prev=R.incomeStatementHistoryQuarterly.incomeStatementHistory[1];
    const rg = prev?((inc.totalRevenue.raw/prev.totalRevenue.raw)-1):0;
    return {ticker,pe,pb,roa,de,pm,rg};
  } catch(e){ return null; }
}

// scoring composito
function score(items){
  const avg = items.reduce((a,x)=>({
    pe:a.pe+(x.pe||0), pb:a.pb+(x.pb||0),
    roa:a.roa+x.roa, de:a.de+x.de,
    pm:a.pm+x.pm, rg:a.rg+x.rg
  }),{pe:0,pb:0,roa:0,de:0,pm:0,rg:0});
  for(let k in avg) avg[k]/=items.length;
  items.forEach(x=>{
    x.score = (x.pe?1/x.pe:0)*.2
            + (x.pb?1/x.pb:0)*.1
            + x.roa*.2
            + (x.de?1/x.de:0)*.1
            + x.pm*.2
            + x.rg*.2;
  });
  return items.sort((a,b)=>b.score-a.score);
}

//–– UI ELEMENTS
const btnScan=document.getElementById("scan"),
      out=document.getElementById("screener-out"),
      progress=document.getElementById("progress");

//–– SCAN SEQUENZIALE CON PROGRESS
btnScan.onclick=async()=>{
  btnScan.disabled=true;
  out.innerHTML="";
  progress.textContent="Avvio scansione… 0%";
  const list = constituents[document.getElementById("idx").value];
  const results = [];
  for(let i=0; i<list.length; i++){
    const t = list[i];
    const f = await fetchFund(t);
    if(f && f.pe!=null) results.push(f);
    const pct = Math.round(((i+1)/list.length)*100);
    progress.textContent = `Lavorazione… ${pct}%`;
  }
  // scoring + render
  const top10 = score(results).slice(0,10);
  top10.forEach((x,i)=>{
    const reasons = [];
    if(x.pe < avg(results,"pe")) reasons.push(`PE basso (${x.pe.toFixed(1)})`);
    if(x.roa> avg(results,"roa")) reasons.push(`ROA alto ${(x.roa*100).toFixed(1)}%`);
    if(x.pm > avg(results,"pm")) reasons.push(`Margine ${(x.pm*100).toFixed(1)}%`);
    if(x.rg > avg(results,"rg")) reasons.push(`Crescita ${(x.rg*100).toFixed(1)}%`);
    if(!reasons.length) reasons.push("Bilancio stabile");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td>
      <td>${x.ticker}</td>
      <td>${x.score.toFixed(3)}</td>
      <td>${reasons.join("; ")}</td>`;
    out.appendChild(tr);
  });
  progress.textContent="Completato!";
  btnScan.disabled=false;
  btnScan.textContent="Scansiona";
};

// media helper
function avg(arr, key){
  return arr.reduce((s,x)=>s+(x[key]||0),0)/arr.length;
}
</script>
</body>
</html> 
